# ==================== SRDM 配置文件 ====================
# SAR-Residual Diffusion Model
# 核心: 预测残差 R = Optical - SAR_base 而非完整图像

# ==================== 数据配置 ====================
data:
  # 数据集类型选择: "whu" 或 "sen12"
  type: "sen12"

  # WHU 数据集配置 (当 type="whu" 时使用)
  #train_dir: "data/train"
  #test_dir: "data/test"

  # SEN1-2 数据集配置 (当 type="sen12" 时使用)
  root: "/root/SEN1-2"

  train_ratio: 0.9
  test_ratio: 0.1

  # SRDM使用[0,1]归一化 (重要!)
  normalize:
    enabled: true
    input_range: [0.0, 1.0]  # Dataset输出范围

  # 通道配置 - 支持4通道数据只取前3通道
  # WHU: sar=1通道, optical=4通道取前3
  # SEN12: sar=3通道, optical=3通道
  channels:
    optical:
      input: 3          # SEN12光学图像输入通道
      use: 3            # 使用3通道
      indices: [0,1,2]  # RGB通道
    sar:
      input: 3          # SEN12 SAR图像输入通道(实际是3通道VV,VH组合)
      use: 3
      indices: [0,1,2]

  dataloader:
    batch_size: 28           # 根据显存调整
    num_workers: 4          # 数据加载worker数
    pin_memory: true        # 锁页内存
    prefetch_factor: 2      # 预取因子
    persistent_workers: true  # 保持worker进程

# ==================== 模型配置 ====================
model:
  type: "srdm"           # 模型类型
  name: "SRDM"
  output_range: [-1.0, 1.0]  # 模型输出范围 (SRDM预测残差)

# ==================== 混合精度配置 ====================
amp:
  enabled: true           # 是否启用自动混合精度 (AMP)
  use_bf16: false         # 是否使用 BF16 (需要 A100/A800 等 Ampere 架构)
                         # FP16 (false) - 通用，但可能需要梯度缩放
                         # BF16 (true)  - A100/A800 推荐，更稳定，无需梯度缩放
  init_scale: 65536.0     # FP16 梯度初始缩放因子 (2^16)
  growth_interval: 2000   # 梯度缩放增长间隔


# SRDM专用配置
srdm:
  base_ch: 64
  ch_mults: [1, 2, 4, 8]
  num_blocks: 2
  time_emb_dim: 256
  dropout: 0.1
  num_heads: 8

# SRDM损失配置 (自由组合)
srdm_loss:
  # 启用的损失项列表 (从下方选择)
  enabled:
    - noise_mse      # 噪声预测MSE (推荐必开)
    - x0_mse         # 残差MSE - 约束残差生成
    - x0_l1          # 残差L1 - 约束残差生成

  # 各损失项权重
  weights:
    noise_mse: 1.0
    noise_l1: 1.0
    x0_mse: 0.5       # 残差MSE权重
    x0_l1: 0.3        # 残差L1权重
    edge_sobel: 0.1
    ssim: 0.1
    perceptual: 0.2

  # 感知损失特定配置
  perceptual_layers: ["relu3_3"]

# ==================== 扩散模型配置 ====================
diffusion:
  num_timesteps: 1000
  beta_start: 0.0001
  beta_end: 0.02

  sampling:
    enabled: true          # 是否启用采样/验证
    use_ddim: true         # 使用DDIM加速采样
    ddim_steps: 50         # DDIM采样步数
    ddim_eta: 0.0          # DDIM噪声参数 (0为确定性)

# ==================== 输出配置 ====================
output:
  composite_range: [0.0, 1.0]  # 合成后范围
  save_format: "uint8"         # 最终保存格式

# ==================== 训练配置 ====================
training:
  num_epochs: 100

  optimizer:
    type: "adamw"
    lr: 0.0002
    weight_decay: 0.01
    betas: [0.9, 0.999]

  scheduler:
    type: "cosine"
    warmup_epochs: 5
    min_lr: 0.000001

  mixed_precision:
    enabled: true

  gradient_clipping:
    enabled: true
    max_norm: 1.0

  gradient_accumulation:
    enabled: true
    steps: 2  # 累积2步，等效batch_size翻倍

# ==================== 验证配置 ====================
validation:
  enabled: true
  interval: 10           # 每10epoch验证一次
  batch_size: 4
  max_samples: 50        # 最大验证样本数

  save_results:
    enabled: true
    save_dir: "results"
    save_grid: true
    grid_cols: 4

# ==================== 设备配置 ====================
device:
  use_cuda: true
  random_seed: 42
  deterministic: false

# ==================== 日志配置 ====================
logging:
  level: "INFO"
  log_dir: "logs"
  tensorboard: true
